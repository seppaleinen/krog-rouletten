version: "2"

services:
  redis:
    image: redis

  postgres:
    image: 'postgres:9.5'
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DBNAME: sentry
      POSTGRES_DBUSER: sentry
      POSTGRES_DBPASS: sentry

  sentry:
    image: 'sentry:8.7'
    links:
     - redis
     - postgres
    ports:
     - "9000:9000"
    depends_on:
    - postgres
    - sentry_upgrade
    - sentry_create_user
    stdin_open: true
    tty: true
    environment:
      SENTRY_SECRET_KEY: verysecret
      SENTRY_POSTGRES_HOST: postgres
      SENTRY_DB_USER: postgres
      SENTRY_DB_PASSWORD: postgres
      SENTRY_REDIS_HOST: redis

  sentry_upgrade:
    image: 'sentry:8.7'
    links:
     - redis
     - postgres
    depends_on:
     - postgres
    stdin_open: true
    tty: true
    environment:
      SENTRY_SECRET_KEY: verysecret
      SENTRY_POSTGRES_HOST: postgres
      SENTRY_DB_USER: postgres
      SENTRY_DB_PASSWORD: postgres
      SENTRY_REDIS_HOST: redis
    command: bash -c "sleep 5; sentry upgrade --no-input"

  sentry_create_user:
    image: 'sentry:8.7'
    links:
     - redis
     - postgres
    depends_on:
     - sentry_upgrade
    stdin_open: true
    tty: true
    environment:
      SENTRY_SECRET_KEY: verysecret
      SENTRY_POSTGRES_HOST: postgres
      SENTRY_DB_USER: postgres
      SENTRY_DB_PASSWORD: postgres
      SENTRY_REDIS_HOST: redis
    command: bash -c "sleep 60 && sentry createuser "--email=test@test.se" "--password=password" "--superuser" "--no-input""

  sentry_celery_beat:
    image: 'sentry:8.7'
    links:
     - redis
     - postgres
    depends_on:
     - postgres
     - sentry_upgrade
     - sentry_create_user
    environment:
      SENTRY_SECRET_KEY: verysecret
      SENTRY_POSTGRES_HOST: postgres
      SENTRY_DB_USER: postgres
      SENTRY_DB_PASSWORD: postgres
      SENTRY_REDIS_HOST: redis
    command: "sentry run cron"

  sentry_celery_worker:
    image: 'sentry:8.7'
    links:
     - redis
     - postgres
    depends_on:
     - postgres
     - sentry_create_user
    environment:
      SENTRY_SECRET_KEY: verysecret
      SENTRY_POSTGRES_HOST: postgres
      SENTRY_DB_USER: postgres
      SENTRY_DB_PASSWORD: postgres
      SENTRY_REDIS_HOST: redis
    command: "sentry run worker"

